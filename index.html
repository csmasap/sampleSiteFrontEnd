<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>THEIA Job Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
    }
    .header .logo {
      font-size: 24px;
      font-weight: bold;
    }
    .nav {
      display: flex;
      gap: 20px;
    }
    .nav a {
      text-decoration: none;
      color: #333;
      font-weight: 500;
    }
    .nav a:hover {
      color: #007bff;
    }
    .buttons {
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-orange {
      background-color: #ff6200;
      color: white;
    }
    .btn-green {
      background-color: #28a745;
      color: white;
    }
    .btn-blue {
      background-color: #007bff;
      color: white;
    }
    .btn-gray {
      background-color: #6c757d;
      color: white;
    }
    .content {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .card {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    .card h3 {
      margin: 0 0 10px;
      color: #333;
    }
    .card p {
      margin: 0;
      color: #666;
    }
    .question-section {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
    }
    .question-section h4 {
      margin: 0 0 10px;
      color: #333;
    }
    .input-group {
      margin-top: 10px;
    }
    .input-group input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .analysis-section {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    .analysis-section textarea {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 100px;
    }
    .analysis-result {
      margin-top: 15px;
      padding: 15px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      white-space: pre-wrap;
    }
    select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #fff;
    }
    .tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    .tab {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom: 2px solid #ff6200;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .prompt-list {
      margin-top: 15px;
    }
    .prompt-item {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      background-color: #fff;
    }
    .prompt-item h4 {
      margin: 0 0 5px;
    }
    .prompt-item p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    .prompt-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-header h3 {
      margin: 0;
    }
    .close {
      cursor: pointer;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <div class="logo">THEIA</div>
      <div class="nav">
        <a href="#">Home</a>
        <a href="#">Products</a>
        <a href="#">Pricing</a>
        <a href="#">About</a>
        <a href="#">Jobs</a>
      </div>
      <div class="buttons">
        <button class="btn btn-orange">Get Started</button>
        <button class="btn btn-green" @click="refreshData">Test Salesforce Connection</button>
      </div>
    </div>
    <div class="content">
      <!-- Job Section -->
      <div v-if="loading" class="loading">Loading data...</div>
      <div v-else>
        <div class="card-container" v-if="jobs.length > 0">
          <div class="card" v-for="job in jobs" :key="job.Id">
            <h3>{{ job.Job_Public_Name__c }}</h3>
            <p>{{ job.Opportunity_Discussed_Question_1__c }}</p>
          </div>
        </div>
        
        <!-- Internal Question Section -->
        <div class="question-section">
          <h4>Internal Question:</h4>
          <p v-if="opportunityDiscussed">{{ opportunityDiscussed.Internal_Q_1__c }}</p>
          <p v-else>Loading internal question...</p>
          <div class="input-group">
            <input 
              type="text" 
              v-model="internalAnswer" 
              :placeholder="opportunityDiscussed ? (opportunityDiscussed.Internal_Answer_1__c || 'Enter your answer...') : 'Loading...'"
              :disabled="!opportunityDiscussed"
            >
            <button 
              class="btn btn-green" 
              @click="updateInternalAnswer"
              :disabled="!opportunityDiscussed"
            >
              Save Answer
            </button>
          </div>
        </div>

        <!-- AI Analysis Section with Tabs -->
        <div class="analysis-section">
          <div class="tabs">
            <div 
              class="tab" 
              :class="{ active: activeTab === 'analysis' }"
              @click="activeTab = 'analysis'"
            >
              AI Analysis
            </div>
            <div 
              class="tab" 
              :class="{ active: activeTab === 'prompts' }"
              @click="activeTab = 'prompts'"
            >
              Manage Prompts
            </div>
          </div>

          <!-- Analysis Tab -->
          <div class="tab-content" :class="{ active: activeTab === 'analysis' }">
            <div class="form-group">
              <label for="prompt-select">Select Prompt Template:</label>
              <select id="prompt-select" v-model="selectedPromptId" @change="onPromptSelect" required>
                <option value="">-- Select a prompt --</option>
                <option v-for="prompt in prompts" :key="prompt.id" :value="prompt.id">
                  {{ prompt.name }}
                </option>
              </select>
            </div>
            <div v-if="selectedPrompt" class="form-group">
              <label>Selected Prompt:</label>
              <p>{{ selectedPrompt.template }}</p>
            </div>
            <button 
              class="btn btn-orange" 
              @click="analyzeWithGemini"
              :disabled="!opportunityDiscussed || !jobs.length || !selectedPromptId"
            >
              Analyze with AI
            </button>
            <div v-if="analysis" class="analysis-result">
              {{ analysis }}
            </div>
          </div>

          <!-- Prompts Management Tab -->
          <div class="tab-content" :class="{ active: activeTab === 'prompts' }">
            <button class="btn btn-green" @click="showAddPromptModal">Add New Prompt</button>
            
            <div class="prompt-list">
              <div v-for="prompt in prompts" :key="prompt.id" class="prompt-item">
                <h4>{{ prompt.name }}</h4>
                <p>{{ prompt.template.substring(0, 100) }}{{ prompt.template.length > 100 ? '...' : '' }}</p>
                <div class="prompt-actions">
                  <button class="btn btn-blue" @click="editPrompt(prompt)">Edit</button>
                  <button 
                    class="btn btn-gray" 
                    @click="deletePrompt(prompt.id)"
                    :disabled="prompt.id === 'custom'"
                  >
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Prompt Modal -->
    <div class="modal" :style="{ display: showModal ? 'block' : 'none' }">
      <div class="modal-content">
        <div class="modal-header">
          <h3>{{ editingPrompt ? 'Edit Prompt' : 'Add New Prompt' }}</h3>
          <span class="close" @click="closeModal">&times;</span>
        </div>
        <div class="form-group">
          <label for="prompt-name">Prompt Name:</label>
          <input type="text" id="prompt-name" v-model="promptForm.name" placeholder="Enter a name for this prompt">
        </div>
        <div class="form-group">
          <label for="prompt-template">Prompt Template:</label>
          <textarea id="prompt-template" v-model="promptForm.template" placeholder="Enter the prompt template text" rows="6"></textarea>
        </div>
        <button class="btn btn-green" @click="savePrompt">Save Prompt</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.8.3/axios.min.js" integrity="sha512-GM+dbfuQPeVaDSIsb+vSOSJJoH3/WP3MstSIL6zYmIPCUY3wNdU32LoaGo2YtXpkP0e6Clpb8cHHHdJ1t4nVfA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script type="module">
    import { createApp, ref } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    const API_URL = 'http://localhost:5038/';

    createApp({
      setup() {
        const jobs = ref([]);
        const opportunityDiscussed = ref(null);
        const internalAnswer = ref('');
        const loading = ref(true);
        const analysis = ref('');
        const activeTab = ref('analysis');
        const prompts = ref([]);
        const selectedPromptId = ref('');
        const selectedPrompt = ref(null);
        const showModal = ref(false);
        const editingPrompt = ref(null);
        const promptForm = ref({
          name: '',
          template: ''
        });

        return {
          jobs,
          opportunityDiscussed,
          internalAnswer,
          loading,
          analysis,
          activeTab,
          prompts,
          selectedPromptId,
          selectedPrompt,
          showModal,
          editingPrompt,
          promptForm
        };
      },
      methods: {
        async getJobs() {
          try {
            const response = await axios.get(API_URL + 'getJobs');
            this.jobs = response.data.records || [];
          } catch (error) {
            console.error('Error fetching jobs:', error);
            this.jobs = [];
          }
        },
        async getOpportunityDiscussed() {
          try {
            const response = await axios.get(API_URL + 'getOpportunityDiscussed');
            this.opportunityDiscussed = response.data.records[0] || null;
            if (this.opportunityDiscussed) {
              this.internalAnswer = this.opportunityDiscussed.Internal_Answer_1__c || '';
            }
          } catch (error) {
            console.error('Error fetching opportunity discussed:', error);
          }
        },
        async updateInternalAnswer() {
          try {
            const response = await axios.post(API_URL + 'updateOpportunityDiscussed', {
              answer: this.internalAnswer
            });
            console.log('Answer updated:', response.data);
            // Refresh the data
            await this.getOpportunityDiscussed();
            alert('Answer saved successfully!');
          } catch (error) {
            console.error('Error updating answer:', error);
            alert('Error saving answer. Please try again.');
          }
        },
        async getPrompts() {
          try {
            const response = await axios.get(API_URL + 'prompts');
            this.prompts = response.data.prompts || [];
          } catch (error) {
            console.error('Error fetching prompts:', error);
            this.prompts = [];
          }
        },
        async analyzeWithGemini() {
          if (!this.selectedPromptId) {
            alert('Please select a prompt template');
            return;
          }
          
          try {
            const response = await axios.post(API_URL + 'processWithGemini', {
              jobData: this.jobs[0],
              opportunityData: this.opportunityDiscussed,
              promptId: this.selectedPromptId
            });
            this.analysis = response.data.analysis;
          } catch (error) {
            console.error('Error analyzing with Gemini:', error);
            alert('Error analyzing with Gemini. Please try again.');
          }
        },
        onPromptSelect() {
          if (this.selectedPromptId === 'custom') {
            this.selectedPrompt = null;
          } else {
            const selectedPrompt = this.prompts.find(p => p.id === this.selectedPromptId);
            if (selectedPrompt) {
              this.selectedPrompt = selectedPrompt;
            }
          }
        },
        async refreshData() {
          this.loading = true;
          await Promise.all([
            this.getJobs(),
            this.getOpportunityDiscussed(),
            this.getPrompts()
          ]);
          this.loading = false;
        },
        showAddPromptModal() {
          this.editingPrompt = null;
          this.promptForm.name = '';
          this.promptForm.template = '';
          this.showModal = true;
        },
        editPrompt(prompt) {
          this.editingPrompt = prompt;
          this.promptForm.name = prompt.name;
          this.promptForm.template = prompt.template;
          this.showModal = true;
        },
        closeModal() {
          this.showModal = false;
        },
        async savePrompt() {
          if (!this.promptForm.name || !this.promptForm.template) {
            alert('Please fill out all fields');
            return;
          }

          try {
            if (this.editingPrompt) {
              // Update existing prompt
              await axios.put(API_URL + 'prompts/' + this.editingPrompt.id, {
                name: this.promptForm.name,
                template: this.promptForm.template
              });
            } else {
              // Add new prompt
              await axios.post(API_URL + 'prompts', {
                name: this.promptForm.name,
                template: this.promptForm.template
              });
            }
            
            await this.getPrompts();
            this.closeModal();
          } catch (error) {
            console.error('Error saving prompt:', error);
            alert('Error saving prompt. Please try again.');
          }
        },
        async deletePrompt(id) {
          if (confirm('Are you sure you want to delete this prompt?')) {
            try {
              await axios.delete(API_URL + 'prompts/' + id);
              await this.getPrompts();
            } catch (error) {
              console.error('Error deleting prompt:', error);
              alert('Error deleting prompt. Please try again.');
            }
          }
        }
      },
      async mounted() {
        await this.refreshData();
      },
    }).mount('#app');
  </script>
</body>
</html>
